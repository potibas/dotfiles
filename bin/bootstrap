#!/bin/zsh
set -e

# Install Homebrew
if ! type brew > /dev/null 2>/dev/null; then
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi

# install tmux 256-color terminalinfo with italics
tic -x ~/.config/tmux/tmux.terminfo

# Install Homebrew formulae and casks
brew bundle

# Symlink specific gcc version
if [ ! -f "/usr/local/bin/gcc" ]; then
  ln -s /usr/local/bin/gcc-13 /usr/local/bin/gcc
  ln -s /usr/local/bin/g++-13 /usr/local/bin/g++
  ln -s "/usr/local/bin/c++-13" "/usr/local/bin/c++"
  ln -s /usr/local/bin/cpp-13 /usr/local/bin/cpp
fi

# install mise (previously rtx)
if [ ! -f "$HOME/.local/mise" ]; then
  echo "Installing mise..."
  curl https://mise.run | sh
fi

# install global tools
echo "Installing global tools"
~/.local/bin/mise install -y

# Link vscode config and install extensions
mkdir -p ~/.config/vscode
for file in settings.json keybindings.json snippets; do
  rm -rf ~/Library/Application\ Support/Code/User/$file
  ln -s ~/.config/vscode/$file ~/Library/Application\ Support/Code/User
done

code \
  --install-extension Equinusocio.vsc-material-theme \
  --install-extension equinusocio.vsc-material-theme-icons \
  --install-extension JakeBecker.elixir-ls \
  --install-extension NikosKornarakis.predawn-twilight \
  --install-extension phoenixframework.phoenix \
  --install-extension vscode-exunit.exunit \
  --force \
  || true

# Sudo without password
# sudo sed -i '' 's/^%admin.*/%admin          ALL = (ALL) NOPASSWD:ALL/' /etc/sudoers

# Un-quarantine  applications
applications=(
  Discord
  Docker
  "Google Chrome"
  Gnucash
  Hammerspoon
  Karabiner-Elements Karabiner-EventViewer
  Keybase
  Kitty
  OmniFocus
  Postman
  Raycast
  Slack
  Skype
  Spotify
  Telegram
  "Visual Studio Code"
  VLC
  Whatsapp
  Zoom.us
)

for app in $applications; do
  echo "unquarantining $app"
  sudo xattr -dr com.apple.quarantine "/Applications/$app.app"
done

# Force en_GB locale for GnuCash
defaults write -app Gnucash AppleLocale 'en_GB.UTF-8'

echo "=== finished bootstrap script, open new terminal session ==="
