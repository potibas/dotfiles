#!/bin/zsh
set -e

# Install Homebrew
if ! type brew > /dev/null 2>/dev/null; then
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi

# install tmux 256-color terminalinfo with italics
tic -x ~/.config/tmux/tmux.terminfo

# Install Homebrew formulae and casks
brew bundle

# install rtx
if [ ! -f "$HOME/bin/rtx" ]; then
  echo "Installing rtx..."
  curl https://rtx.pub/rtx-latest-macos-x64 > ~/bin/rtx 2> /dev/null
  chmod +x ~/bin/rtx
fi

# install global tools
echo "Installing global tools"
~/bin/rtx install

# Link vscode config and install extensions
mkdir -p ~/.config/vscode
for file in settings.json keybindings.json snippets; do
  rm -rf ~/Library/Application\ Support/Code/User/$file
  ln -s ~/.config/vscode/$file ~/Library/Application\ Support/Code/User
done

code \
  --install-extension asvetliakov.vscode-neovim \
  --install-extension Equinusocio.vsc-material-theme \
  --install-extension equinusocio.vsc-material-theme-icons \
  --install-extension JakeBecker.elixir-ls \
  --install-extension NikosKornarakis.predawn-twilight \
  --install-extension phoenixframework.phoenix \
  --install-extension vscode-exunit.exunit \
  --force \
  || true

# Sudo without password
sudo sed -i '' 's/^%admin.*/%admin          ALL = (ALL) NOPASSWD:ALL/' /etc/sudoers

# Un-quarantine  applications
applications=(
  Discord
  Docker
  GitX
  "Google Chrome"
  Gnucash
  Hammerspoon
  Karabiner-Elements Karabiner-EventViewer
  Keybase
  Kitty
  OmniFocus
  Postman
  Raycast
  Slack
  Skype
  Spotify
  Telegram
  "Visual Studio Code"
  VLC
  Whatsapp
  Zoom.us
)

for app in $applications; do
  echo "unquarantining $app"
  sudo xattr -dr com.apple.quarantine "/Applications/$app.app"
done

# Force en_GB locale for GnuCash
defaults write -app Gnucash AppleLocale 'en_GB.UTF-8'

echo "=== finished bootstrap script, open new terminal session ==="
